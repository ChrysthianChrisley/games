XWUZ={},XWUZ.games={},XWUZ.game="";var heightScore=0;XWUZ.say=function(){return{alert:function(e){XWUZ.flow.pause(),document.getElementById("alertbox").style.display="block",document.getElementById("alertbox_content").innerHTML=e+'<br style="clear:both" /><br /><a href="#" onclick="XWUZ.say.dismiss(); XWUZ.flow.restart();return false;"><img src="./i/b_okay.png" alt="Okay" /></a>'},confirm:function(e){XWUZ.flow.pause(),document.getElementById("alertbox").style.display="block",document.getElementById("alertbox_content").innerHTML=e+'<br style="clear:both" /><br /><a href="#" onclick="XWUZ.say.dismiss(); XWUZ.flow.restart();return false;"><img src="./i/b_yes.png" alt="Yes" /></a><a href="#" onclick="XWUZ.say.dismiss(); XWUZ.flow.resume(); return false;"><img src="./i/b_no.png" alt="No" /></a>'},dismiss:function(){document.getElementById("alertbox").style.display="",document.getElementById("alertbox_content").innerHTML=""}}}(),XWUZ.cookie=function(){var e=new Date,t=new Date,n="xwuz.com";return t.setTime(e.getTime()+7776e6),{set:function(e,r){return document.cookie=e+"="+encodeURIComponent(r)+"; expires="+t.toGMTString()+";domain="+n+";path=/;",r},get:function(e){var t,n,r;t=e+"=";if(document.cookie.length>0){n=document.cookie.indexOf(t);if(n!==-1)return n+=t.length,r=document.cookie.indexOf(";",n),r===-1&&(r=document.cookie.length),decodeURIComponent(document.cookie.substring(n,r))}return""},del:function(e){var t=new Date;document.cookie=e+"="+"; expires=Thu, 01-Jan-70 00:00:01 GMT"+"; domain="+n+";path=/;"}}}(),XWUZ.menu=function(){var e,t;return e={game:{position:0,bgpos:0},highscore:{position:-320,bgpos:-72},about:{position:-640,bgpos:-182}},e.game.active=!0,t={running:!1,steps:5},{setMenu:function(){e.highscore.position=-480,e.about.position=-960},get:function(){var t;for(t in e)if(e.hasOwnProperty(t)&&e[t].active)return t},set:function(n){var r,i;if(t.running)return!1;if(e[n].active&&n==="game"){XWUZ.say.confirm("<h1>New game</h1>Do you really want to<br />restart your game?");return}return e[n].active?!1:(i=XWUZ.menu.get(),t.running=!0,t.from=e[i].position,t.to=e[n].position,t.stepnow=0,e[i].active=!1,e[n].active=!0,document.getElementById("button_"+n).getElementsByTagName("span")[0].style.backgroundPosition=e[n].bgpos+"px 0",document.getElementById("button_"+i).getElementsByTagName("span")[0].style.backgroundPosition=e[i].bgpos+"px -41px",r=function(){t.stepnow<t.steps?(t.stepnow+=1,document.getElementById("stage_contents").style.marginLeft=t.from+(t.to-t.from)*(t.stepnow===t.steps?1:1-1/Math.pow(2,t.stepnow))+"px",setTimeout(r,50)):(delete t.from,delete t.to,delete t.stepnow,t.running=!1)},r(),!1)}}}(),XWUZ.flow=function(){var e="STATIC";return{getstatus:function(){return e},restart:function(){},pause:function(){},resume:function(){}}}();XWUZ.game="bubble",XWUZ.games.bubble=function(){return{init:function(){XWUZ.flow=XWUZ.games[XWUZ.game].flow,XWUZ.games.bubble.engine.start(),XWUZ.say.alert('<h1>消除方块</h1><p style="margin: 0 20px 0 20px; text-align:left;"><img src="./i/icon.png" alt="Bubble Trouble" style="width:64px; height:64px;float:left; margin-right:5px;"/>点击至少3块以上相同颜色的方块，方块会自动消除，消除的方块数越多，获取的分数也越高。</p><div style="width:110px; margin:30px auto -30px auto;"></div>'),document.body.addEventListener&&document.body.addEventListener("touchmove",function(e){e.preventDefault()},!1)},flow:function(){var e="splash";return{getstatus:function(){return e},restart:function(){e==="splash"?(e="running",XWUZ.games.bubble.flow.resume()):(e="running",XWUZ.games.bubble.engine.start())},pause:function(){e==="running"&&(e="paused")},resume:function(){e==="paused"&&(e="running")}}}(),engine:function(){var e={tablew:9,tableh:8,bubblew:33,bubbleh:33},t=function(t){if(t.x>=0&&t.y>=0&&t.x<e.tablew&&t.y<e.tableh&&document.getElementById("bubble_elem_"+t.x+"_"+t.y))return document.getElementById("bubble_elem_"+t.x+"_"+t.y)},n=function(n){var r=document.createElement("span");return r.className="bubble",r.style.marginLeft=n.x*e.bubblew+"px",r.style.marginTop=n.y*e.bubbleh+"px",r.style.backgroundPosition="0 -"+n.type*e.bubbleh+"px",r.id="bubble_elem_"+n.x+"_"+n.y,r.x=n.x,r.y=n.y,r.type=n.type,r.append=function(){document.getElementById("bt_realarea").appendChild(this)},r.show=function(){this.style.opacity=1,this.style.cursor="pointer"},r.remove=function(e){document.getElementById("bt_realarea").removeChild(this)},r.fall=function(e){this.id="bubble_elem_"+this.x+"_"+e.y,this.y=e.y},r.onmousedown=function(){var n={},r=t({x:this.x,y:this.y}).type;return XWUZ.games.bubble.engine.floodcheck({x:this.x,y:this.y,type:this.type})&&(e.points[e.cycle]=0,XWUZ.games.bubble.engine.floodrem({x:this.x,y:this.y}),XWUZ.games.bubble.engine.setscore(),e.cycle+=1),!1},r.ontouchstart=r.onmousedown,r};return{cleanup:function(){var n,r;e.level=0,e.scoreperlevel=[0],e.score=0,e.cycle=0,e.points=[0],e.evil=.8,e.colors=3;for(n=0;n<e.tablew;n+=1)for(r=0;r<e.tableh;r+=1)t({x:n,y:r})&&t({x:n,y:r}).remove();document.getElementById("score").className="",document.getElementById("score").innerHTML=e.score,document.getElementById("level").innerHTML=e.level,document.getElementById("combo").innerHTML=e.points[e.cycle]},start:function(){e.gamesplayed=parseInt(XWUZ.cookie.get("bubble_gamesplayed"),10)||0,e.yourbest=heightScore,XWUZ.games.bubble.engine.cleanup(),XWUZ.games.bubble.engine.newlevel()},newlevel:function(){e.level===5?(e.colors=4,e.evil=.7):e.level===10?(e.colors=5,e.evil=.6):e.level===15&&(e.colors=6,e.evil=.5),e.level+=1,XWUZ.games.bubble.engine.setlevel();var r,i,s,o;o=[];for(r=0;r<e.tablew;r+=1)for(i=0;i<e.tableh;i+=1)t({x:r,y:i})||(s=n({x:r,y:i,type:Math.random()>e.evil?(r+i*2)%4:Math.floor(Math.random()*e.colors)}),s.append(),o.push({x:r,y:i}));XWUZ.games.bubble.engine.bulkshow(o),XWUZ.games.bubble.engine.levelendcheck()&&setTimeout(XWUZ.games.bubble.engine.gameover,600)},setscore:function(){e.score+=Math.floor(e.points[e.cycle]*(e.points[e.cycle]-1)/2*(Math.log(e.level)+1)),e.scoreperlevel[e.level]=e.score,document.getElementById("score").innerHTML=e.score,e.score>e.yourbest&&(document.getElementById("score").className="highscore"),document.getElementById("combo").innerHTML=e.points[e.cycle]},setlevel:function(){document.getElementById("level").innerHTML=e.level},floodcheck:function(e){var n={},r=0;return t({x:e.x-1,y:e.y})&&t({x:e.x-1,y:e.y}).type===e.type&&(r+=1,n={x:e.x-1,y:e.y}),t({x:e.x,y:e.y-1})&&t({x:e.x,y:e.y-1}).type===e.type&&(r+=1,n={x:e.x,y:e.y-1}),t({x:e.x+1,y:e.y})&&t({x:e.x+1,y:e.y}).type===e.type&&(r+=1,n={x:e.x+1,y:e.y}),t({x:e.x,y:e.y+1})&&t({x:e.x,y:e.y+1}).type===e.type&&(r+=1,n={x:e.x,y:e.y+1}),r===0?!1:r>=2?!0:e.tried?!1:(n.type=e.type,n.tried=!0,XWUZ.games.bubble.engine.floodcheck(n))},bulkshow:function(e){var n,r=5,i=[];for(n=0;n<r;n+=1)i[n]=[];for(n=0;n<e.length;n+=1)i[Math.floor(Math.random()*r)].push(t({x:e[n].x,y:e[n].y}));var s=function(){var e,t,n;n=0;if(i.length>0){do t=i.pop();while(t&&t.length===0);if(t){for(e=0;e<t.length;e+=1)t[e].show();setTimeout(s,50)}}};s()},bulkfall:function(t){var n=0,r=function(){var s;if(n<t.length+3){if(t[n])for(s=0;s<t[n].length;s+=1)t[n][s].style.marginTop=Math.floor(t[n][s].y*e.bubbleh-e.bubbleh/2)+"px";if(t[n-1])for(s=0;s<t[n-1].length;s+=1)t[n-1][s].style.marginTop=t[n-1][s].y*e.bubbleh-1+"px";if(t[n-2])for(s=0;s<t[n-2].length;s+=1)t[n-2][s].style.marginTop=t[n-2][s].y*e.bubbleh-2+"px";if(t[n-3])for(s=0;s<t[n-3].length;s+=1)t[n-3][s].style.marginTop=t[n-3][s].y*e.bubbleh+"px";n+=1,setTimeout(r,50)}};r()},floodrem:function(n){var r=t({x:n.x,y:n.y}).type,i=function(n){var s;s=t({x:n.x,y:n.y}),s&&s.type===r&&(e.points[e.cycle]+=1,t({x:n.x,y:n.y}).remove(),i({x:n.x-1,y:n.y}),i({x:n.x,y:n.y-1}),i({x:n.x+1,y:n.y}),i({x:n.x,y:n.y+1}))};i(n),XWUZ.games.bubble.engine.fall(),XWUZ.games.bubble.engine.levelendcheck()&&setTimeout(XWUZ.games.bubble.engine.newlevel,200)},fall:function(){var n,r,i,s,o,u;s=[];for(n=0;n<e.tablew;n+=1){o=[],u=e.tableh-1;for(r=e.tableh-1;r>=0;r-=1)i=t({x:n,y:r}),i&&(u>r&&(i.fall({y:u}),o.push(i)),u-=1);o.length>0&&s.push(o)}XWUZ.games.bubble.engine.bulkfall(s)},levelendcheck:function(){var e,t=document.getElementById("bt_realarea").getElementsByTagName("span");for(e=0;e<t.length;e+=1)if(XWUZ.games.bubble.engine.floodcheck({x:t[e].x,y:t[e].y,type:t[e].type}))return!1;return!0},gameover:function(){e.gamesplayed+=1,XWUZ.cookie.set("bubble_gamesplayed",e.gamesplayed),e.score>e.yourbest?(XWUZ.say.alert("<h1>游戏结束</h1>重新开始?"),e.yourbest=e.score,heightScore=e.score):XWUZ.say.alert("<h1>游戏结束</h1>重新开始?")}}}()}}();